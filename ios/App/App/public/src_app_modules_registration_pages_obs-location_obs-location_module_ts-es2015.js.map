{"version":3,"file":"src_app_modules_registration_pages_obs-location_obs-location_module_ts-es2015.js","mappings":"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","sources":["./src/app/modules/registration/pages/obs-location/obs-location.module.ts","./src/app/modules/registration/pages/obs-location/obs-location.page.ts","./src/app/modules/registration/pages/obs-location/obs-location.page.html"],"sourcesContent":["import { NgModule } from '@angular/core';\r\nimport { Routes, RouterModule } from '@angular/router';\r\nimport { ObsLocationPage } from './obs-location.page';\r\nimport { SharedComponentsModule } from '../../shared-components.module';\r\nimport { SaveAsDraftRouteGuard } from '../save-as-draft.guard';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: ObsLocationPage,\r\n    canDeactivate: [SaveAsDraftRouteGuard]\r\n  }\r\n];\r\n\r\n@NgModule({\r\n  imports: [SharedComponentsModule, RouterModule.forChild(routes)],\r\n  declarations: [ObsLocationPage]\r\n})\r\nexport class ObsLocationPageModule {}\r\n","import { Component, OnInit, NgZone, OnDestroy, ViewChild } from '@angular/core';\r\nimport * as L from 'leaflet';\r\nimport { IRegistration } from 'src/app/modules/common-registration/registration.models';\r\nimport { RegistrationService } from '../../services/registration.service';\r\nimport { NavController } from '@ionic/angular';\r\nimport {\r\n  ObsLocationsResponseDtoV2,\r\n  ObsLocationEditModel\r\n} from '@varsom-regobs-common/regobs-api';\r\nimport { ActivatedRoute } from '@angular/router';\r\nimport { GeoHazard } from '@varsom-regobs-common/core';\r\nimport { Observable, Subscription } from 'rxjs';\r\nimport { FullscreenService } from '../../../../core/services/fullscreen/fullscreen.service';\r\nimport { SwipeBackService } from '../../../../core/services/swipe-back/swipe-back.service';\r\nimport { LoggedInUser } from '../../../login/models/logged-in-user.model';\r\nimport { SetLocationInMapComponent } from '../../components/set-location-in-map/set-location-in-map.component';\r\nimport { UserSettingService } from '../../../../core/services/user-setting/user-setting.service';\r\nimport { take } from 'rxjs/operators';\r\nimport { RegobsAuthService } from '../../../auth/services/regobs-auth.service';\r\n\r\nconst DEBUG_TAG = 'ObsLocationPage';\r\n\r\n@Component({\r\n  selector: 'app-obs-location',\r\n  templateUrl: './obs-location.page.html',\r\n  styleUrls: ['./obs-location.page.scss']\r\n})\r\nexport class ObsLocationPage implements OnInit, OnDestroy {\r\n  locationMarker: L.Marker;\r\n  isLoaded = false;\r\n  selectedLocation: ObsLocationsResponseDtoV2;\r\n  registration: IRegistration;\r\n  fullscreen$: Observable<boolean>;\r\n  geoHazard: GeoHazard;\r\n  isSaveDisabled = false;\r\n  @ViewChild(SetLocationInMapComponent)\r\n  setLocationInMapComponent: SetLocationInMapComponent;\r\n\r\n  private subscription: Subscription;\r\n  private loggedInUser: LoggedInUser;\r\n\r\n  constructor(\r\n    private registrationService: RegistrationService,\r\n    private activatedRoute: ActivatedRoute,\r\n    private ngZone: NgZone,\r\n    private navController: NavController,\r\n    private fullscreenService: FullscreenService,\r\n    private swipeBackService: SwipeBackService,\r\n    private userSettingService: UserSettingService,\r\n    private regobsAuthService: RegobsAuthService\r\n  ) {\r\n    this.fullscreen$ = this.fullscreenService.isFullscreen$;\r\n  }\r\n\r\n  async ngOnInit() {\r\n    const id = this.activatedRoute.snapshot.params['id'];\r\n    if (id) {\r\n      this.registration = await this.registrationService.getSavedRegistrationById(\r\n        id\r\n      );\r\n      this.geoHazard = this.registration?.geoHazard;\r\n    } else if (this.activatedRoute.snapshot.params['geoHazard']) {\r\n      this.geoHazard = parseInt(\r\n        this.activatedRoute.snapshot.params['geoHazard'],\r\n        10\r\n      );\r\n    }\r\n    if (this.geoHazard == null) {\r\n      // No geohazard found, use app mode\r\n      const userSettings = await this.userSettingService.userSetting$\r\n        .pipe(take(1))\r\n        .toPromise();\r\n      this.geoHazard = userSettings.currentGeoHazard[0];\r\n    }\r\n    if (this.hasLocation(this.registration)) {\r\n      const locationMarkerIcon = L.icon({\r\n        iconUrl: '/assets/icon/map/obs-location.svg',\r\n        iconSize: [25, 41],\r\n        iconAnchor: [12, 41],\r\n        shadowUrl: 'leaflet/marker-shadow.png',\r\n        shadowSize: [41, 41]\r\n      });\r\n      this.locationMarker = L.marker(\r\n        {\r\n          lat: this.registration.request.ObsLocation.Latitude,\r\n          lng: this.registration.request.ObsLocation.Longitude\r\n        },\r\n        { icon: locationMarkerIcon }\r\n      );\r\n      this.selectedLocation = {\r\n        Name:\r\n          this.registration.request.ObsLocation.LocationName ||\r\n          this.registration.request.ObsLocation.LocationDescription,\r\n        Id: this.registration.request.ObsLocation.ObsLocationID\r\n      };\r\n    }\r\n    this.subscription = this.regobsAuthService.loggedInUser$.subscribe(\r\n      (val) => {\r\n        this.loggedInUser = val;\r\n      }\r\n    );\r\n\r\n    this.ngZone.run(() => {\r\n      this.isLoaded = true;\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.subscription) {\r\n      this.subscription.unsubscribe();\r\n    }\r\n  }\r\n\r\n  ionViewDidEnter() {\r\n    this.swipeBackService.disableSwipeBack();\r\n  }\r\n\r\n  ionViewWillLeave() {\r\n    this.swipeBackService.enableSwipeBack();\r\n  }\r\n\r\n  private hasLocation(reg: IRegistration) {\r\n    return (\r\n      reg &&\r\n      reg.request.ObsLocation &&\r\n      reg.request.ObsLocation.Latitude &&\r\n      reg.request.ObsLocation.Longitude\r\n    );\r\n  }\r\n\r\n  async onLocationSet(event: ObsLocationEditModel) {\r\n    this.ngZone.run(() => {\r\n      this.isSaveDisabled = true;\r\n    });\r\n    if (!this.registration) {\r\n      this.registration = this.registrationService.createNewRegistration(\r\n        this.geoHazard,\r\n      );\r\n    }\r\n    await this.setLocationAndSaveRegistration(event);\r\n    if (this.registration.request.DtObsTime) {\r\n      this.navController.navigateForward(\r\n        'registration/edit/' + this.registration.id\r\n      );\r\n    } else {\r\n      this.navController.navigateForward(\r\n        'registration/set-time/' + this.registration.id\r\n      );\r\n    }\r\n  }\r\n\r\n  private async setLocationAndSaveRegistration(loc: ObsLocationEditModel) {\r\n    if (loc === undefined || this.registration === undefined) {\r\n      return;\r\n    }\r\n    this.registration.request.ObsLocation = loc;\r\n    await this.registrationService.saveRegistrationAsync(this.registration);\r\n    this.isSaveDisabled = false;\r\n  }\r\n}\r\n","<ion-header *ngIf=\"!(fullscreen$ | async)\">\r\n  <ion-toolbar appHeaderColor mode=\"ios\">\r\n    <ion-buttons slot=\"start\">\r\n      <ion-back-button text=\"\" defaultHref=\"/\"></ion-back-button>\r\n    </ion-buttons>\r\n    <ion-title>\r\n      {{'REGISTRATION.OBS_LOCATION.TITLE' | translate}}\r\n    </ion-title>\r\n  </ion-toolbar>\r\n</ion-header>\r\n<ion-content>\r\n  <app-set-location-in-map *ngIf=\"isLoaded\" [geoHazard]=\"geoHazard\" [locationMarker]=\"locationMarker\"\r\n    (locationSet)=\"onLocationSet($event)\" [selectedLocation]=\"selectedLocation\" [allowEditLocationName]=\"true\"\r\n    [isSaveDisabled]=\"isSaveDisabled\">\r\n  </app-set-location-in-map>\r\n</ion-content>"],"names":[],"sourceRoot":"webpack:///"}