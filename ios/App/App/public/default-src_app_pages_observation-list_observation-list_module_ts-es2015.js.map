{"version":3,"file":"default-src_app_pages_observation-list_observation-list_module_ts-es2015.js","mappings":"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","sources":["./src/app/pages/modal-pages/fullscreen-image-modal/fullscreen-image-modal.module.ts","./src/app/pages/observation-list/observation-list.module.ts","./src/app/pages/observation-list/observation-list.page.ts","./src/app/pages/observation-list/observation-list.page.html"],"sourcesContent":["import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { FullscreenImageModalPage } from './fullscreen-image-modal.page';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, IonicModule, FormsModule],\r\n  declarations: [FullscreenImageModalPage],\r\n  entryComponents: [FullscreenImageModalPage]\r\n})\r\nexport class FullscreenImageModalPageModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { Routes, RouterModule } from '@angular/router';\r\nimport { ObservationListPage } from './observation-list.page';\r\nimport { SharedModule } from '../../modules/shared/shared.module';\r\nimport { FullscreenImageModalPageModule } from '../modal-pages/fullscreen-image-modal/fullscreen-image-modal.module';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: ObservationListPage\r\n  }\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    FullscreenImageModalPageModule,\r\n    SharedModule,\r\n    RouterModule.forChild(routes)\r\n  ],\r\n  declarations: [ObservationListPage]\r\n})\r\nexport class ObservationListPageModule {}\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  ViewChild,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { ObservationService } from '../../core/services/observation/observation.service';\r\nimport * as L from 'leaflet';\r\nimport { Subject } from 'rxjs';\r\nimport { map, take, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { MapService } from '../../modules/map/services/map/map.service';\r\nimport { IMapView } from '../../modules/map/services/map/map-view.interface';\r\nimport { RegistrationViewModel } from '@varsom-regobs-common/regobs-api';\r\nimport { IonContent, IonInfiniteScroll } from '@ionic/angular';\r\nimport { DataMarshallService } from '../../core/services/data-marshall/data-marshall.service';\r\nimport { UserSettingService } from 'src/app/core/services/user-setting/user-setting.service';\r\nimport { NgDestoryBase } from 'src/app/core/helpers/observable-helper';\r\nimport { LangKey } from '@varsom-regobs-common/core';\r\n\r\nconst PAGE_SIZE = 10;\r\nconst MAX_OBSERVATION_COUNT = 100;\r\n\r\n@Component({\r\n  selector: 'app-observation-list',\r\n  templateUrl: './observation-list.page.html',\r\n  styleUrls: ['./observation-list.page.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ObservationListPage extends NgDestoryBase implements OnInit {\r\n  visibleObservations: RegistrationViewModel[];\r\n  allObservations: RegistrationViewModel[];\r\n  loaded = false;\r\n  cancelSubject: Subject<unknown>;\r\n  private pageIndex = 0;\r\n  private total: number;\r\n  private langKey: LangKey;\r\n\r\n  @ViewChild(IonContent, { static: true }) content: IonContent;\r\n  @ViewChild(IonInfiniteScroll, { static: false }) scroll: IonInfiniteScroll;\r\n\r\n  trackByIdFunc = this.trackByIdFuncInternal.bind(this);\r\n  refreshFunc = this.refresh.bind(this);\r\n\r\n  constructor(\r\n    private observationService: ObservationService,\r\n    private dataMarshallService: DataMarshallService,\r\n    private cdr: ChangeDetectorRef,\r\n    private mapService: MapService,\r\n    private userSettingService: UserSettingService,\r\n  ) {\r\n    super()\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    this.cancelSubject = this.dataMarshallService.observableCancelSubject;\r\n    this.userSettingService.language$.pipe(takeUntil(this.ngDestroy$)).subscribe((langKey) => {\r\n      this.langKey = langKey;\r\n    })\r\n  }\r\n\r\n  refresh(cancelPromise: Promise<unknown>): void {\r\n    this.resetAndLoadObservations(true, cancelPromise);\r\n  }\r\n\r\n  ionViewWillEnter(): void {\r\n    this.content.scrollToTop();\r\n    this.resetAndLoadObservations();\r\n  }\r\n\r\n  ionViewWillLeave(): void {\r\n    this.loaded = false;\r\n    this.visibleObservations = undefined;\r\n  }\r\n\r\n  private async resetAndLoadObservations(\r\n    forceUpdate = false,\r\n    cancelPromise: Promise<unknown> = undefined\r\n  ): Promise<void> {\r\n    this.loaded = false;\r\n    this.visibleObservations = undefined;\r\n    this.cdr.detectChanges();\r\n    if (forceUpdate) {\r\n      await this.observationService.forceUpdateObservationsForCurrentGeoHazard(\r\n        cancelPromise\r\n      );\r\n    }\r\n    this.loadObservations();\r\n  }\r\n\r\n  private async loadObservations() {\r\n    this.allObservations = await this.getObservationsInMap();\r\n    this.total = this.allObservations.length;\r\n    this.pageIndex = 0;\r\n    this.visibleObservations = this.allObservations.slice(0, 10);\r\n\r\n    this.cdr.detectChanges();\r\n    setTimeout(() => {\r\n      this.loaded = true;\r\n      this.scroll.disabled = false;\r\n      this.cdr.detectChanges();\r\n    }, 500);\r\n  }\r\n\r\n  private getObservationsInMap(): Promise<RegistrationViewModel[]> {\r\n    return this.mapService.mapView$\r\n      .pipe(\r\n        switchMap((mapView: IMapView) =>\r\n          this.observationService.observations$.pipe(\r\n            map((observations) =>\r\n              this.filterObservationsWithinViewBounds(observations, mapView)\r\n            ),\r\n            map((observations) => observations.slice(0, MAX_OBSERVATION_COUNT))\r\n          )\r\n        ),\r\n        take(1)\r\n      )\r\n      .toPromise();\r\n  }\r\n\r\n  loadNextPage(event: CustomEvent<IonInfiniteScroll>): void {\r\n    this.pageIndex += 1;\r\n    const startIndex = this.pageIndex * PAGE_SIZE;\r\n    this.visibleObservations.push(\r\n      ...this.allObservations.slice(startIndex, startIndex + PAGE_SIZE)\r\n    );\r\n\r\n    const target: IonInfiniteScroll = (event.target as unknown) as IonInfiniteScroll;\r\n    target.complete();\r\n    if (this.visibleObservations.length >= this.total) {\r\n      target.disabled = true; //we have reached the end, so no need to load more pages from now\r\n    }\r\n  }\r\n\r\n  get maxCountReached(): boolean {\r\n    return this.visibleObservations.length >= MAX_OBSERVATION_COUNT;\r\n  }\r\n\r\n  get maxCount(): number {\r\n    return MAX_OBSERVATION_COUNT;\r\n  }\r\n\r\n  private filterObservationsWithinViewBounds(\r\n    observations: RegistrationViewModel[],\r\n    view: IMapView\r\n  ) {\r\n    return observations.filter(\r\n      (observation) =>\r\n        !view ||\r\n        view.bounds.contains(\r\n          L.latLng(\r\n            observation.ObsLocation.Latitude,\r\n            observation.ObsLocation.Longitude\r\n          )\r\n        )\r\n    );\r\n  }\r\n\r\n  private trackByIdFuncInternal(_, obs: RegistrationViewModel) {\r\n    return obs ? this.observationService.uniqueObservation(obs, this.langKey) : undefined;\r\n  }\r\n}\r\n","<app-header title=\"{{ 'OBSERVATION_LIST.OBSERVATIONS' | translate }}\"></app-header>\r\n<ion-content>\r\n  <app-refresh-with-cancel [refreshFunc]=\"refreshFunc\"></app-refresh-with-cancel>\r\n  <ng-container *ngIf=\"visibleObservations !== undefined\">\r\n    <ion-list [ngClass]=\"{ loaded: loaded }\" *ngIf=\"(visibleObservations.length > 0) else empty\">\r\n      <ion-item-divider>\r\n        <h3 class=\"ion-text-uppercase\">{{'OBSERVATION_LIST.IN_MAP_VIEW' | translate }}</h3>\r\n      </ion-item-divider>\r\n      <app-observation-list-card *ngFor=\"let obs of visibleObservations; trackBy: trackByIdFunc;\" [obs]=\"obs\">\r\n      </app-observation-list-card>\r\n    </ion-list>\r\n    <ion-infinite-scroll (ionInfinite)=\"loadNextPage($event)\" >\r\n      <ion-infinite-scroll-content>\r\n      </ion-infinite-scroll-content>\r\n    </ion-infinite-scroll>\r\n    <ion-row *ngIf=\"maxCountReached\" class=\"full-grid-row max-count-reached\">\r\n      <ion-col class=\"ion-text-center ion-margin-horizontal\">\r\n        <h2>{{ 'OBSERVATION_LIST.MAX_COUNT_REACHED_HEADER' | translate }}</h2>\r\n        <h3 class=\"ion-text-wrap\"> {{ 'OBSERVATION_LIST.MAX_COUNT_REACHED_TEXT' | translate: {maxCount: maxCount} }}</h3>\r\n      </ion-col>\r\n    </ion-row>\r\n  </ng-container>\r\n  <div class=\"loading-sceleton\" *ngIf=\"!loaded\">\r\n    <ion-item-divider>\r\n      <h3 class=\"ion-text-uppercase\">{{'OBSERVATION_LIST.IN_MAP_VIEW' | translate }}</h3>\r\n    </ion-item-divider>\r\n    <app-observation-skeleton></app-observation-skeleton>\r\n    <app-observation-skeleton></app-observation-skeleton>\r\n    <app-observation-skeleton></app-observation-skeleton>\r\n  </div>\r\n  <app-geo-fab slot=\"fixed\"></app-geo-fab>\r\n</ion-content>\r\n<app-add-menu></app-add-menu>\r\n<ng-template #empty>\r\n  <ion-grid *ngIf=\"loaded\" class=\"full-grid\">\r\n    <ion-row class=\"full-grid-row\">\r\n      <ion-col class=\"ion-align-self-center\">\r\n        <div class=\"center\">\r\n          <svg-icon class=\"rectangle\" src=\"/assets/images/empty-states/rectangle.svg\"></svg-icon>\r\n          <svg-icon class=\"pin1\" src=\"/assets/images/empty-states/pin.svg\"></svg-icon>\r\n          <svg-icon class=\"pin2\" src=\"/assets/images/empty-states/pin.svg\"></svg-icon>\r\n          <svg-icon class=\"pin3\" src=\"/assets/images/empty-states/pin.svg\"></svg-icon>\r\n        </div>\r\n      </ion-col>\r\n    </ion-row>\r\n    <ion-row class=\"full-grid-row\">\r\n      <ion-col class=\"ion-text-center ion-margin-horizontal\">\r\n        <h2> {{ 'OBSERVATION_LIST.NO_OBSERVATIONS' | translate }}</h2>\r\n        <h3 class=\"ion-text-wrap\">{{'OBSERVATION_LIST.NO_OBSERVATIONS_TEXT'|translate}}</h3>\r\n      </ion-col>\r\n    </ion-row>\r\n  </ion-grid>\r\n</ng-template>"],"names":[],"sourceRoot":"webpack:///"}