{"version":3,"mappings":"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","names":["isSameObserver","reg","observer","NickName","Observer","isInGroup","ObserverGroupID","MemberOfGroups","length","map","g","Id","indexOf","isModerator","GeoHazardTID","Roles","_a","includes","getObserverEditCheckObservable","getWithin48HoursCheckUntilFalseObservable","pipe","within48hours","undefined","completeWith","predicate","source","rxjs__WEBPACK_IMPORTED_MODULE_3__","subscribe","value","next","complete","error","forthyEightHoursInMS","timerCheckEveryMinuteMS","isWithinMilliseconds","moment__WEBPACK_IMPORTED_MODULE_0___default","DtRegTime","val","m","msLimit","now","isSameOrAfter","subtract","FullscreenImageModalPageModule","_angular_common__WEBPACK_IMPORTED_MODULE_2__","_ionic_angular__WEBPACK_IMPORTED_MODULE_3__","_angular_forms__WEBPACK_IMPORTED_MODULE_4__","declarations","_fullscreen_image_modal_page__WEBPACK_IMPORTED_MODULE_0__","imports","routes","path","component","_view_observation_page__WEBPACK_IMPORTED_MODULE_0__","ViewObservationPageModule","_modules_shared_shared_module__WEBPACK_IMPORTED_MODULE_1__","_modal_pages_fullscreen_image_modal_fullscreen_image_modal_module__WEBPACK_IMPORTED_MODULE_2__","_angular_router__WEBPACK_IMPORTED_MODULE_4__","_angular_core__WEBPACK_IMPORTED_MODULE_9__","ViewObservationPage","activatedRoute","observationService","userSettingService","popupInfoService","registrationService","router","regobsAuthService","registration","editExistingRegistrationAndSave","navigate","id","checkObservationInfoPopup","ngDestroy$","parseInt","snapshot","params","registrationViewModel$","userSetting$","userSetting","getObservationById","appMode","language","editMode$","createEditMode$","myPageData$","_core_helpers_observable_helper__WEBPACK_IMPORTED_MODULE_3__","selectors","features","decls","vars","consts","template"],"sources":["webpack:///src/app/modules/registration/edit-registration-helper-functions.ts","webpack:///src/app/pages/modal-pages/fullscreen-image-modal/fullscreen-image-modal.module.ts","webpack:///src/app/pages/view-observation/view-observation.module.ts","webpack:///src/app/pages/view-observation/view-observation.page.html","webpack:///src/app/pages/view-observation/view-observation.page.ts"],"sourcesContent":["import { RegistrationViewModel, MyPageData } from '@varsom-regobs-common/regobs-api';\r\nimport { Observable, of, timer } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport moment from 'moment';\r\n\r\nexport type EditMode = 'EDIT_AS_MODERATOR' | 'EDIT_OWN_REGISTRATION';\r\n\r\nexport function isSameObserver(reg: RegistrationViewModel, observer: MyPageData): boolean {\r\n  if (!observer) {\r\n    return false;\r\n  }\r\n  return observer.NickName === reg.Observer.NickName; // TODO: Change to ObserverID, when implemented in API model (MyPageData)\r\n}\r\n\r\nexport function isInGroup(reg: RegistrationViewModel, observer: MyPageData): boolean {\r\n  if (\r\n    observer &&\r\n    reg.ObserverGroupID > 0 &&\r\n    observer.MemberOfGroups &&\r\n    observer.MemberOfGroups.length > 0 &&\r\n    observer.MemberOfGroups.map((g) => g.Id).indexOf(reg.ObserverGroupID) >= 0\r\n  ) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction isModerator(reg: RegistrationViewModel, observer: MyPageData): boolean {\r\n  if (observer && reg.GeoHazardTID) {\r\n    return observer.Roles?.includes(`ModeratorForGeoHazard${reg.GeoHazardTID}`);\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function getObserverEditCheckObservable(reg: RegistrationViewModel, observer: MyPageData): Observable<EditMode> {\r\n  if (isModerator(reg, observer)) {\r\n    return of('EDIT_AS_MODERATOR');\r\n  }\r\n  if (isSameObserver(reg, observer) || isInGroup(reg, observer)) {\r\n    return getWithin48HoursCheckUntilFalseObservable(reg).pipe(\r\n      map((within48hours) => (within48hours ? 'EDIT_OWN_REGISTRATION' : undefined))\r\n    );\r\n  }\r\n  return of(undefined);\r\n}\r\n\r\nexport function getWithin48HoursCheckUntilFalseObservable(reg: RegistrationViewModel): Observable<boolean> {\r\n  const completeWith =\r\n    <T>(predicate: (arg: T) => boolean) =>\r\n    (source: Observable<T>) =>\r\n      new Observable<T>((observer) =>\r\n        source.subscribe(\r\n          (value) => {\r\n            observer.next(value);\r\n            if (predicate(value)) {\r\n              observer.complete();\r\n            }\r\n          },\r\n          (error) => observer.error(error),\r\n          () => observer.complete()\r\n        )\r\n      );\r\n\r\n  const forthyEightHoursInMS = 48 * 60 * 60 * 1000;\r\n  const timerCheckEveryMinuteMS = 60 * 1000;\r\n  return timer(0, timerCheckEveryMinuteMS).pipe(\r\n    map(() => isWithinMilliseconds(moment(reg.DtRegTime), forthyEightHoursInMS)),\r\n    completeWith((val) => !val)\r\n  );\r\n}\r\n\r\nexport function isWithinMilliseconds(m: moment.Moment, msLimit: number, now: moment.Moment = moment()): boolean {\r\n  if (!m) {\r\n    return false;\r\n  }\r\n  return m.isSameOrAfter(now.subtract(msLimit, 'milliseconds'));\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { FullscreenImageModalPage } from './fullscreen-image-modal.page';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, IonicModule, FormsModule],\r\n  declarations: [FullscreenImageModalPage],\r\n  entryComponents: [FullscreenImageModalPage]\r\n})\r\nexport class FullscreenImageModalPageModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { Routes, RouterModule } from '@angular/router';\r\nimport { ViewObservationPage } from './view-observation.page';\r\nimport { SharedModule } from '../../modules/shared/shared.module';\r\nimport { FullscreenImageModalPageModule } from '../modal-pages/fullscreen-image-modal/fullscreen-image-modal.module';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: ViewObservationPage\r\n  }\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    SharedModule,\r\n    FullscreenImageModalPageModule,\r\n    RouterModule.forChild(routes)\r\n  ],\r\n  declarations: [ViewObservationPage]\r\n})\r\nexport class ViewObservationPageModule {}\r\n","<ion-header>\r\n  <ion-toolbar appHeaderColor mode=\"ios\">\r\n    <ion-buttons slot=\"start\">\r\n      <ion-back-button text=\"\" defaultHref=\"/\"></ion-back-button>\r\n    </ion-buttons>\r\n    <ion-title>\r\n      {{'REGISTRATION.OVERVIEW.TITLE' | translate}}\r\n    </ion-title>\r\n  </ion-toolbar>\r\n</ion-header>\r\n<ion-content *ngIf=\"registrationViewModel$ | async as registration\">\r\n  <ng-container *ngIf=\"editMode$ | async as editMode\">\r\n    <span *ngIf=\"editMode === 'EDIT_AS_MODERATOR'\">\r\n      {{ \"RegistrationDetail.EditInfoAsModerator\" | translate }}\r\n    </span>\r\n    <span *ngIf=\"editMode === 'EDIT_OWN_REGISTRATION'\">\r\n      {{ \"RegistrationDetail.EditInfo\" | translate }}\r\n    </span>\r\n    <ion-button (click)=editRegistration(registration)>Edit registration</ion-button>\r\n  </ng-container>\r\n  <app-observation-list-card [obs]=\"registration\"></app-observation-list-card>\r\n</ion-content>","import { Component, OnInit, ChangeDetectionStrategy } from '@angular/core';\r\nimport { ActivatedRoute, Router } from '@angular/router';\r\nimport { ObservationService } from '../../core/services/observation/observation.service';\r\nimport { UserSettingService } from '../../core/services/user-setting/user-setting.service';\r\nimport { RegistrationViewModel } from '@varsom-regobs-common/regobs-api';\r\nimport { PopupInfoService } from '../../core/services/popup-info/popup-info.service';\r\nimport { NgDestoryBase } from '../../core/helpers/observable-helper';\r\nimport { takeUntil, switchMap, withLatestFrom, tap } from 'rxjs/operators';\r\nimport { RegistrationService } from 'src/app/modules/common-registration/registration.services';\r\nimport { from, Observable } from 'rxjs';\r\nimport { EditMode, getObserverEditCheckObservable } from 'src/app/modules/registration/edit-registration-helper-functions';\r\nimport { RegobsAuthService } from 'src/app/modules/auth/services/regobs-auth.service';\r\n\r\n@Component({\r\n  selector: 'app-view-observation',\r\n  templateUrl: './view-observation.page.html',\r\n  styleUrls: ['./view-observation.page.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ViewObservationPage extends NgDestoryBase implements OnInit {\r\n  editMode$: Observable<EditMode>;\r\n  registrationViewModel$: Observable<RegistrationViewModel>;\r\n\r\n  constructor(\r\n    private activatedRoute: ActivatedRoute,\r\n    private observationService: ObservationService,\r\n    private userSettingService: UserSettingService,\r\n    private popupInfoService: PopupInfoService,\r\n    private registrationService: RegistrationService,\r\n    private router: Router,\r\n    private regobsAuthService: RegobsAuthService\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  async editRegistration(registration: RegistrationViewModel) {\r\n    const reg = await this.registrationService.editExistingRegistrationAndSave(registration);\r\n    this.router.navigate(['registration', 'edit', reg.id]);\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.popupInfoService.checkObservationInfoPopup().pipe(takeUntil(this.ngDestroy$)).subscribe();\r\n    const id = parseInt(this.activatedRoute.snapshot.params['id'], 10);\r\n    this.registrationViewModel$ = this.userSettingService.userSetting$.pipe(\r\n      switchMap((userSetting) => from(this.observationService.getObservationById(id, userSetting.appMode, userSetting.language)))\r\n    );\r\n    this.editMode$ = this.createEditMode$();\r\n  }\r\n\r\n  private createEditMode$(): Observable<EditMode> {\r\n    return this.registrationViewModel$.pipe(\r\n      withLatestFrom(this.regobsAuthService.myPageData$),\r\n      switchMap(([reg, observer]) => getObserverEditCheckObservable(reg, observer))\r\n    );\r\n  }\r\n}\r\n"]}