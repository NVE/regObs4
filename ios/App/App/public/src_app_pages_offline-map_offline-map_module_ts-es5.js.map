{"version":3,"mappings":"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","names":["CompoundPackage","metadata","bbox","xMin","yMin","xMax","yMax","type","geometry","coordinates","properties","id","GetFeatureId","xyz","sizeInMib","x","y","z","GetNameFromXYZ","maps","length","moment__WEBPACK_IMPORTED_MODULE_0___default","map","p","lastModified","toDate","urls","name","url","reduce","a","b","concat","routes","path","component","_offline_map_page__WEBPACK_IMPORTED_MODULE_0__","OfflineMapPageModule","_angular_common__WEBPACK_IMPORTED_MODULE_5__","_angular_forms__WEBPACK_IMPORTED_MODULE_6__","_ionic_angular__WEBPACK_IMPORTED_MODULE_7__","_angular_router__WEBPACK_IMPORTED_MODULE_8__","src_app_modules_map_map_module__WEBPACK_IMPORTED_MODULE_1__","_angular_common_http__WEBPACK_IMPORTED_MODULE_9__","src_app_modules_shared_shared_module__WEBPACK_IMPORTED_MODULE_2__","declarations","_offline_package_modal_offline_package_modal_component__WEBPACK_IMPORTED_MODULE_3__","imports","_angular_core__WEBPACK_IMPORTED_MODULE_8__","PACKAGE_INDEX_URL","filledTileOpacity","notFilledTileOpacity","documentStyle","getComputedStyle","document","body","defaultTileStyle","color","getPropertyValue","opacity","fillOpacity","downloadedTileStyle","errorTileStyle","OfflineMapPage","helperService","modalController","offlineMapService","alertController","translateService","zone","http","Map","rxjs__WEBPACK_IMPORTED_MODULE_9__","rxjs__WEBPACK_IMPORTED_MODULE_10__","packagesOnServer$","get","pipe","packageIndex","nameAndPkg","_metadata_model__WEBPACK_IMPORTED_MODULE_4__","downloadAndUnzipProgress$","items","sort","downloadStart","installedPackages$","packages$","downloaded","item","getFeatureIdForPackage","allPackages$","inProgress","packageTotals$","packages","count","space","mapPackage","size","spaceWithUnit","humanReadableByteSize","numPackages","spaceUsed","window","LEAFLET_MAP","setZoom","tilesLayer","leaflet__WEBPACK_IMPORTED_MODULE_2__","onEachFeature","feature","layer","featureMap","set","on","packagesOnServer","has","installedPackages","showModal","next","addLayer","subscribe","packageMap","forEach","addData","getFeature","ngDestroy$","setStyleForPackages","itemsWithProgress","failedPackageIds","filter","error","runOutsideAngular","setStyleForProgressOrDownloadedPackage","isZooming","showPackageModal","key","style","includes","setStyleForFeature","polyline","setStyle","downloadComplete","getProgressOpacity","Object","progressValue","progress","percentage","Math","min","compoundPackageMetadata","getFeaturePropertyId","getXYZ","firstMap","keys","rootTile","compoundPackage","getName","create","componentProps","packageOnServer","offlinePackageStatus$","find","swipeToClose","mode","modal","present","bytes","fractionDigits","isNaN","value","round","event","stopPropagation","isDownloaded","toTranslate","translations","message","buttons","text","role","handler","removeMapPackageByName","alert","cancelDownloadPackage","availableDiskspace","_a","available","src_app_core_helpers_observable_helper__WEBPACK_IMPORTED_MODULE_5__","selectors","features","decls","vars","consts","template","ctx","_angular_core__WEBPACK_IMPORTED_MODULE_5__","ctx_r0","OfflinePackageModalComponent","cdr","isCheckingAvailableDiskspace","offlinePackageStatusThatTriggersChangeDetection$","detectChanges","tileLayer","leaflet__WEBPACK_IMPORTED_MODULE_0__","getBounds","getCenter","lat","lng","center","zoom","finishedPackageIds$","packageName","dismiss","addTo","checkAvailableDiskSpace","downloadPackage","src_app_core_helpers_observable_helper__WEBPACK_IMPORTED_MODULE_3__","inputs","_r2"],"sources":["webpack:///src/app/pages/offline-map/metadata.model.ts","webpack:///src/app/pages/offline-map/offline-map.module.ts","webpack:///src/app/pages/offline-map/offline-map.page.html","webpack:///src/app/pages/offline-map/offline-map.page.ts","webpack:///src/app/pages/offline-map/offline-package-modal/offline-package-modal.component.html","webpack:///src/app/pages/offline-map/offline-package-modal/offline-package-modal.component.ts"],"sourcesContent":["import type { BBox, Feature, Polygon } from 'geojson';\r\nimport moment, { Moment } from 'moment';\r\n\r\ntype XYZ = [number, number, number];\r\n\r\nexport interface PackageMetadata {\r\n  name: string;\r\n  lastModified: string;  // in UTC\r\n  urls: string[];\r\n  sizeInMib: number;\r\n}\r\n\r\nexport interface CompoundPackageMetadata {\r\n  id: string;\r\n  xyz: XYZ;\r\n  bbox: BBox;\r\n  sizeInMib: number;\r\n  maps: PackageMetadata[]\r\n}\r\n\r\nexport interface Part {\r\n  name: string;\r\n  url: string;\r\n}\r\n\r\nexport type CompoundPackageFeature = Feature<Polygon, null>;\r\n\r\nexport class CompoundPackage {\r\n\r\n  static GetNameFromXYZ(x: number, y: number, z: number) {\r\n    return `${x}-${y}-${z}`;\r\n  }\r\n\r\n  static GetFeatureId(x: number, y: number, z: number) {\r\n    return CompoundPackage.GetNameFromXYZ(x, y, z);\r\n  }\r\n\r\n  private metadata: CompoundPackageMetadata;\r\n\r\n  constructor(metadata: CompoundPackageMetadata) {\r\n    this.metadata = metadata;\r\n  }\r\n\r\n  getFeature(): CompoundPackageFeature {\r\n    const [xMin, yMin, xMax, yMax] = this.metadata.bbox;\r\n    return {\r\n      type: 'Feature',\r\n      geometry: {\r\n        bbox: this.metadata.bbox,\r\n        type: 'Polygon',\r\n        coordinates: [[\r\n          [xMin, yMin],\r\n          [xMin, yMax],\r\n          [xMax, yMax],\r\n          [xMax, yMin],\r\n          [xMin, yMin]\r\n        ]]\r\n      },\r\n      properties: null,\r\n      id: CompoundPackage.GetFeatureId(...this.metadata.xyz)\r\n    };\r\n  }\r\n\r\n  getSizeInMiB(): number {\r\n    return this.metadata.sizeInMib;\r\n  }\r\n\r\n  getName(): string {\r\n    const [x, y, z] = this.metadata.xyz;\r\n    return CompoundPackage.GetNameFromXYZ(x, y, z);\r\n  }\r\n\r\n  getLastModified(): Date {\r\n    if (this.metadata.maps.length === 0) {\r\n      return null;\r\n    }\r\n    return moment.max(this.metadata.maps.map(p => moment(p.lastModified))).toDate();\r\n  }\r\n\r\n  getParts(): Part[] {\r\n    return this.metadata.maps\r\n      // Hent name / url for alle pakker\r\n      .map((p) => p.urls.map(url => ({name: p.name, url})))\r\n      // Flatten array\r\n      .reduce((a, b) => a.concat(b), []);\r\n  }\r\n\r\n  getXYZ(): XYZ {\r\n    return this.metadata.xyz;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { IonicModule } from '@ionic/angular';\r\n\r\nimport { OfflineMapPage } from './offline-map.page';\r\nimport { MapModule } from 'src/app/modules/map/map.module';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { SharedModule } from 'src/app/modules/shared/shared.module';\r\nimport { OfflinePackageModalComponent } from './offline-package-modal/offline-package-modal.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: OfflineMapPage\r\n  }\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    IonicModule,\r\n    RouterModule.forChild(routes),\r\n    MapModule,\r\n    HttpClientModule,\r\n    SharedModule\r\n  ],\r\n  declarations: [OfflineMapPage, OfflinePackageModalComponent]\r\n})\r\nexport class OfflineMapPageModule {}\r\n","<ion-header>\r\n  <ion-toolbar appHeaderColor mode=\"ios\">\r\n    <ion-buttons slot=\"start\">\r\n      <ion-back-button text=\"\" defaultHref=\"/\"></ion-back-button>\r\n    </ion-buttons>\r\n    <ion-title>{{ 'OFFLINE_MAP.OFFLINE_MAP_PAGE_TITLE' | translate }}</ion-title>\r\n  </ion-toolbar>\r\n</ion-header>\r\n\r\n<ion-content>\r\n  <div class=\"map-container\">\r\n    <app-map\r\n      (mapReady)=\"onMapReady($event)\"\r\n      [offlinePackageMode]=\"true\"\r\n      [showScale]=\"false\"\r\n      [showMapSearch]=false\r\n      [showFullscreenToggle]=false\r\n      [showGpsCenter]=true\r\n      [showUserLocation]=\"true\"\r\n      [showSupportMaps]=\"false\"\r\n      [autoActivate]=\"true\"\r\n      [geoTag]=\"'package-map'\"\r\n    ></app-map>\r\n  </div>\r\n</ion-content>\r\n<ion-footer>\r\n  <ion-list>\r\n    <ion-item *ngIf=\"packageTotals$ | async as packageTotals\" (click)=\"expanded = !expanded\" lines=\"full\">\r\n      <ion-label *ngIf=\"packageTotals.numPackages === 1\" class=\"package-count\">{{ 'OFFLINE_MAP.PACKAGE_COUNT_SINGLE' | translate:{packageCount: packageTotals.numPackages} }}</ion-label>\r\n      <ion-label *ngIf=\"packageTotals.numPackages !== 1\" class=\"package-count\">{{ 'OFFLINE_MAP.PACKAGE_COUNT_MULTIPLE' | translate:{packageCount: packageTotals.numPackages} }}</ion-label>\r\n      <ion-label class=\"packages-size\">{{ packageTotals.spaceUsed }}</ion-label>\r\n      <ion-label class=\"space-available\">({{ 'OFFLINE_MAP.SPACE_AVAILABLE' | translate:{spaceAvailable: getSpaceAvailable()} }})</ion-label>\r\n      <ion-icon *ngIf=\"packageTotals.numPackages > 0\" slot=\"end\" [name]=\"expanded ? 'chevron-down-circle' : 'chevron-up-circle'\" class=\"expand-icon\"></ion-icon>\r\n    </ion-item>\r\n    <div class=\"footer\">\r\n      <ng-container *ngIf=\"expanded && allPackages$ | async as items\">\r\n        <ion-item (click)=\"showPackageModalForPackage(item)\" *ngFor=\"let item of items\" lines=\"full\">\r\n          <ion-label>{{ item.name }}</ion-label>\r\n          <ion-label>{{ humanReadableByteSize(item.size) }}</ion-label>\r\n          <ion-label>{{ formatProgressIfDownloading(item) }}</ion-label>\r\n          <ion-icon slot=\"end\" *ngIf=\"item.error\" name=\"warning-outline\"></ion-icon>\r\n          <ion-icon slot=\"end\" *ngIf=\"!(item.error)\" (click)=\"cancelOrDelete(item, $event)\" name=\"trash-outline\"></ion-icon>\r\n        </ion-item>\r\n      </ng-container>\r\n    </div>\r\n  </ion-list>\r\n</ion-footer>\r\n","import { Component, NgZone } from '@angular/core';\r\nimport { OfflineMapService } from '../../core/services/offline-map/offline-map.service';\r\nimport { OfflineMapPackage } from '../../core/services/offline-map/offline-map.model';\r\nimport { HelperService } from '../../core/services/helpers/helper.service';\r\nimport { AlertController, ModalController } from '@ionic/angular';\r\nimport { BehaviorSubject, combineLatest, firstValueFrom, from, Observable, Subject } from 'rxjs';\r\nimport { debounceTime, filter, map, shareReplay, switchMap, takeUntil, tap, withLatestFrom } from 'rxjs/operators';\r\nimport * as L from 'leaflet';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { OfflinePackageModalComponent } from './offline-package-modal/offline-package-modal.component';\r\nimport { CompoundPackage, CompoundPackageMetadata, CompoundPackageFeature } from './metadata.model';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { NgDestoryBase } from 'src/app/core/helpers/observable-helper';\r\n\r\nconst PACKAGE_INDEX_URL = 'https://offlinemap.blob.core.windows.net/packages/packageIndex_v2.json';\r\nconst filledTileOpacity = 0.8;\r\nconst notFilledTileOpacity = 0.1;\r\nconst documentStyle = getComputedStyle(document.body);\r\nconst defaultTileStyle = {\r\n  color: documentStyle.getPropertyValue('--ion-color-primary'),\r\n  opacity: 1,\r\n  fillOpacity: notFilledTileOpacity\r\n};\r\nconst downloadedTileStyle = {\r\n  ...defaultTileStyle,\r\n  fillOpacity: filledTileOpacity,\r\n};\r\nconst errorTileStyle = {\r\n  ...downloadedTileStyle,\r\n  color: documentStyle.getPropertyValue('--ion-color-danger'),\r\n};\r\n\r\ntype PackageIndex = CompoundPackageMetadata[];\r\n\r\ninterface PackageTotals {\r\n  numPackages: number,\r\n  spaceUsed: string\r\n}\r\n\r\n@Component({\r\n  selector: 'app-offline-map',\r\n  templateUrl: './offline-map.page.html',\r\n  styleUrls: ['./offline-map.page.scss']\r\n})\r\nexport class OfflineMapPage extends NgDestoryBase {\r\n  private readonly installedPackages$: Observable<Map<string, OfflineMapPackage>>;\r\n  private installedPackages: Map<string, OfflineMapPackage> = new Map();\r\n  private failedPackageIds: string[] = []; //remember failed packages until features are ready for styling\r\n  private downloadAndUnzipProgress$: Observable<OfflineMapPackage[]>;\r\n  packageTotals$: Observable<PackageTotals>;\r\n  readonly allPackages$: Observable<OfflineMapPackage[]>;\r\n  private packagesOnServer$: Observable<Map<string, CompoundPackage>>;\r\n  private packagesOnServer: Map<string, CompoundPackage> = new Map();\r\n  showTileCard = true;\r\n  tilesLayer: L.GeoJSON;\r\n  // Could not get the click handler to only emit once per click, so wrapped this in a subject\r\n  showModal = new Subject<CompoundPackageFeature>();\r\n  isZooming = new BehaviorSubject<boolean>(false);\r\n  featureMap = new Map<string, { feature: CompoundPackageFeature, layer: L.Layer }>();\r\n  expanded = false; //show list of downloads if this is true\r\n\r\n  constructor(\r\n    private helperService: HelperService,\r\n    private modalController: ModalController,\r\n    private offlineMapService: OfflineMapService,\r\n    private alertController: AlertController,\r\n    private translateService: TranslateService,\r\n    private zone: NgZone,\r\n    http: HttpClient,\r\n  ) {\r\n    super();\r\n    // Download package index from azure\r\n    this.packagesOnServer$ = http.get<PackageIndex>(PACKAGE_INDEX_URL).pipe(\r\n      // Map downloaded package index to a packageName => package map\r\n      map((packageIndex) => {\r\n        const nameAndPkg: [string, CompoundPackage][] = packageIndex.map(p => [\r\n          CompoundPackage.GetNameFromXYZ(...p.xyz),\r\n          new CompoundPackage(p)\r\n        ]);\r\n        return new Map(nameAndPkg);\r\n      }),\r\n      shareReplay()\r\n    );\r\n\r\n    this.downloadAndUnzipProgress$ = this.offlineMapService.downloadAndUnzipProgress$\r\n      .pipe(map((items) => items.sort(((a, b) => b.downloadStart - a.downloadStart))));\r\n    this.installedPackages$ = this.offlineMapService.packages$\r\n      .pipe(map((downloaded) => new Map(downloaded.map((item) => [this.getFeatureIdForPackage(item), item]))));\r\n    this.allPackages$ = combineLatest([\r\n      this.offlineMapService.downloadAndUnzipProgress$,\r\n      this.offlineMapService.packages$\r\n    ]).pipe((map(([inProgress, downloaded]) => [...inProgress, ...downloaded])));\r\n\r\n    this.packageTotals$ = this.allPackages$.pipe(\r\n      map((packages) => {\r\n        let count = 0;\r\n        let space = 0;\r\n        for (const mapPackage of packages) {\r\n          count += 1;\r\n          space += mapPackage.size;\r\n        }\r\n        let spaceWithUnit = '0 MB';\r\n        if (space > 0) {\r\n          spaceWithUnit = this.humanReadableByteSize(space);\r\n        }\r\n        return { numPackages: count, spaceUsed: spaceWithUnit };\r\n      })\r\n    );\r\n  }\r\n\r\n  onMapReady(map: L.Map) {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    (window as any).LEAFLET_MAP = map;\r\n\r\n    map.setZoom(7);\r\n\r\n    this.tilesLayer = new L.GeoJSON(null, {\r\n      onEachFeature: (feature: CompoundPackageFeature, layer) => {\r\n        this.featureMap.set(feature.id as string, { feature, layer });\r\n        layer.on('click', () => {\r\n          if(this.packagesOnServer.has(feature.id as string) || this.installedPackages.has(feature.id as string)) {\r\n            this.showModal.next(feature);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    map.addLayer(this.tilesLayer);\r\n\r\n    this.packagesOnServer$.subscribe(packageMap => {\r\n      packageMap.forEach((mapPackage) => {\r\n        this.tilesLayer.addData(mapPackage.getFeature());\r\n      });\r\n    });\r\n\r\n    combineLatest([\r\n      this.installedPackages$,\r\n      this.packagesOnServer$\r\n    ])\r\n      .pipe(takeUntil(this.ngDestroy$))\r\n      .subscribe(([installedPackages, packagesOnServer]) => {\r\n        this.installedPackages = installedPackages;\r\n        this.packagesOnServer = packagesOnServer;\r\n        this.setStyleForPackages();\r\n      });\r\n\r\n    this.downloadAndUnzipProgress$.pipe(takeUntil(this.ngDestroy$)).pipe(\r\n      tap((itemsWithProgress) => {\r\n        this.failedPackageIds = itemsWithProgress.filter(item => item.error).map(item => item.name);\r\n      })\r\n    ).subscribe((itemsWithProgress) => {\r\n      this.zone.runOutsideAngular(() => {\r\n        for(const item of itemsWithProgress) {\r\n          this.setStyleForProgressOrDownloadedPackage(item);\r\n        }\r\n      });\r\n    });\r\n\r\n    this.showModal.pipe(\r\n      debounceTime(200),\r\n      withLatestFrom(this.isZooming),\r\n      filter(([, isZooming]) => !isZooming),\r\n      switchMap(([feature, ]) => from(this.showPackageModal(feature))),\r\n      takeUntil(this.ngDestroy$)\r\n    ).subscribe();\r\n\r\n    // This is to avoid pinch-zooming on map triggers click event\r\n    map.on('dragend zoomend', () => {\r\n      this.isZooming.next(false);\r\n    });\r\n    map.on('dragstart zoomstart', () => {\r\n      this.isZooming.next(true);\r\n    });\r\n  }\r\n\r\n  private setStyleForPackages() {\r\n    for(const [, item] of this.installedPackages) {\r\n      this.setStyleForProgressOrDownloadedPackage(item);\r\n    }\r\n    for(const [key, ] of this.packagesOnServer) {\r\n      let style = defaultTileStyle;\r\n      if(!this.installedPackages.has(key)) {\r\n        if (this.failedPackageIds.includes(key)) {\r\n          style = errorTileStyle;\r\n        }\r\n        this.setStyleForFeature(key, style);\r\n      }\r\n    }\r\n  }\r\n\r\n  private setStyleForFeature(id: string, style: L.PathOptions) {\r\n    const feature = this.featureMap.get(id);\r\n    if(feature) {\r\n      const polyline = (feature.layer as L.Polyline);\r\n      polyline.setStyle(style);\r\n    }\r\n  }\r\n\r\n  private setStyleForProgressOrDownloadedPackage(item: OfflineMapPackage) {\r\n    const id = this.getFeatureIdForPackage(item);\r\n    if (item.error) {\r\n      this.setStyleForFeature(id, errorTileStyle);\r\n    } else {\r\n      const fillOpacity = item.downloadComplete ? 0 : this.getProgressOpacity(item);\r\n      this.setStyleForFeature(id, { ...defaultTileStyle, fillOpacity });\r\n    }\r\n  }\r\n\r\n  private getProgressOpacity(item: OfflineMapPackage) {\r\n    const progressValue = (item.progress ? (item.progress.percentage / 2.0) : 0) + 0.4;\r\n    return Math.min(progressValue, filledTileOpacity);\r\n  }\r\n\r\n  private getFeaturePropertyId(x: number, y: number, z: number) {\r\n    return CompoundPackage.GetNameFromXYZ(x, y, z);\r\n  }\r\n\r\n  private getFeatureIdForPackage(map: OfflineMapPackage): string {\r\n    if(map.compoundPackageMetadata) {\r\n      return this.getFeaturePropertyId(...map.compoundPackageMetadata.getXYZ());\r\n    }\r\n    const firstMap = Object.keys(map.maps)[0];\r\n    if(map.maps[firstMap]) {\r\n      const rootTile = map.maps[firstMap].rootTile;\r\n      return this.getFeaturePropertyId(rootTile.x, rootTile.y, rootTile.z);\r\n    }\r\n    return '';\r\n  }\r\n\r\n\r\n  async showPackageModal(feature: CompoundPackageFeature) {\r\n    const compoundPackage = this.packagesOnServer.get(feature.id as string);\r\n    const name = compoundPackage.getName();\r\n    const modal = await this.modalController.create({\r\n      component: OfflinePackageModalComponent,\r\n      componentProps: {\r\n        feature: feature,\r\n        packageOnServer: compoundPackage,\r\n        offlinePackageStatus$: this.allPackages$.pipe(\r\n          map(packages => packages.find(p => p.name === name))),\r\n      },\r\n      swipeToClose: true,\r\n      mode: 'ios'\r\n    });\r\n    await modal.present();\r\n  }\r\n\r\n  showPackageModalForPackage(map: OfflineMapPackage) {\r\n    const feature = this.featureMap.get(map.name);\r\n    if (feature) {\r\n      this.showPackageModal(feature.feature);\r\n    }\r\n  }\r\n\r\n  humanReadableByteSize(bytes: number, fractionDigits = 0): string {\r\n    if (isNaN(bytes)) {\r\n      return '';\r\n    }\r\n    return this.helperService.humanReadableByteSize(bytes, fractionDigits, true);\r\n  }\r\n\r\n  formatProgressIfDownloading(map: OfflineMapPackage): string {\r\n    if (map.downloadStart && !map.downloadComplete) {\r\n      const value = Math.round((map.progress ? map.progress.percentage : 0) * 100);\r\n      return `(${value}%)`;\r\n    }\r\n    return '';\r\n  }\r\n\r\n  async cancelOrDelete(map: OfflineMapPackage, event: Event) {\r\n    event.stopPropagation();\r\n    if (this.isDownloaded(map)) {\r\n      const toTranslate = ['OFFLINE_MAP.DELETE_PACKAGE_CONFIRM', 'DIALOGS.CANCEL', 'DIALOGS.DELETE'];\r\n      const translations = await firstValueFrom(this.translateService.get(toTranslate));\r\n      const alert = await this.alertController.create({\r\n        message: translations['OFFLINE_MAP.DELETE_PACKAGE_CONFIRM'],\r\n        buttons: [\r\n          {\r\n            text: translations['DIALOGS.CANCEL'],\r\n            role: 'cancel'\r\n          },\r\n          {\r\n            text: translations['DIALOGS.DELETE'],\r\n            handler: () => {\r\n              this.offlineMapService.removeMapPackageByName(map.name);\r\n            }\r\n          }\r\n        ]\r\n      });\r\n      alert.present();\r\n    } else {\r\n      this.offlineMapService.cancelDownloadPackage(map);\r\n    }\r\n  }\r\n\r\n  isDownloaded(map: OfflineMapPackage): boolean {\r\n    return !!map.downloadComplete;\r\n  }\r\n\r\n  getSpaceAvailable(): string {\r\n    return this.humanReadableByteSize(this.offlineMapService.availableDiskspace?.available, 0);\r\n  }\r\n}\r\n","<ion-header translucent>\r\n  <ion-toolbar>\r\n    <ion-title>{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.HEADER' | translate:{name: packageOnServer.getName()} }}</ion-title>\r\n    <ion-buttons slot=\"end\">\r\n      <ion-button (click)=\"dismiss()\">{{ 'CLOSE' | translate }}</ion-button>\r\n    </ion-buttons>\r\n  </ion-toolbar>\r\n</ion-header>\r\n\r\n<ion-content>\r\n  <div class=\"map-container\" *ngIf=\"center\">\r\n    <app-map\r\n      [offlinePackageMode]=\"true\"\r\n      [showMapSearch]=false\r\n      [showFullscreenToggle]=false\r\n      [showGpsCenter]=false\r\n      [showUserLocation]=\"false\"\r\n      [showSupportMaps]=\"false\"\r\n      [center]=\"center\"\r\n      [zoom]=\"zoom\"\r\n      (mapReady)=\"showTileOnMap($event)\"\r\n    ></app-map>\r\n  </div>\r\n  <ion-grid>\r\n\r\n    <ion-row>\r\n      <ion-col size=\"4\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.PACKAGE_PRODUCED_DATE' | translate }}</ion-col>\r\n      <ion-col>{{ packageOnServer.getLastModified() | date:'short' }}</ion-col>\r\n    </ion-row>\r\n\r\n    <ion-row>\r\n      <ion-col size=\"4\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.PACKAGE_SIZE' | translate }}</ion-col>\r\n      <ion-col>{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.PACKAGE_SIZE_VALUE_WITH_UNIT' | translate:{size: packageOnServer.getSizeInMiB() | number: '1.0-1'} }}</ion-col>\r\n    </ion-row>\r\n\r\n    <div *ngIf=\"offlinePackageStatusThatTriggersChangeDetection$ | async as packageStatus else downloadPackage\">\r\n      <ion-row>\r\n        <ion-col size=\"4\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.PACKAGE_DOWNLOAD_STATUS' | translate }}</ion-col>\r\n        <ion-col>\r\n          {{ packageStatus.progress?.description }}\r\n          <span *ngIf=\"!!packageStatus.downloadComplete\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.PACKAGE_DOWNLOADED_DATE' | translate:{date: packageStatus.downloadComplete * 1000 | date:'short'} }} </span>\r\n          <span *ngIf=\"!packageStatus.downloadComplete\">({{getPercentage(packageStatus) +'%' }})</span>\r\n        </ion-col>\r\n        <ion-col size=\"1\">\r\n          <ion-icon *ngIf=\"!!packageStatus.downloadComplete\" name=\"checkmark\"></ion-icon>\r\n          <ion-icon *ngIf=\"!packageStatus.error && packageStatus.progress?.step === 0\" name=\"stopwatch-outline\">\r\n          </ion-icon>\r\n          <ion-icon *ngIf=\"!packageStatus.error && packageStatus.progress?.step === 1\" name=\"cloud-download-outline\">\r\n          </ion-icon>\r\n          <ion-icon *ngIf=\"!packageStatus.error && packageStatus.progress?.step === 2\" name=\"folder-open-outline\">\r\n          </ion-icon>\r\n          <ion-icon *ngIf=\"packageStatus.error\" name=\"warning-outline\"></ion-icon>\r\n        </ion-col>\r\n      </ion-row>\r\n      <ion-row *ngIf=\"!packageStatus.downloadComplete && !packageStatus.error\">\r\n        <ion-col>\r\n          <ion-button expand=\"block\" color=\"danger\" (click)=\"cancel(packageStatus)\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.CANCEL_DOWNLOAD_BUTTON' | translate }}</ion-button>\r\n        </ion-col>\r\n      </ion-row>\r\n      <ion-row *ngIf=\"packageStatus.error\">\r\n        <ion-col>\r\n          <ion-button expand=\"block\" color=\"varsom-orange\" (click)=\"startDownload()\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.TRY_AGAIN_BUTTON' | translate }}</ion-button>\r\n        </ion-col>\r\n      </ion-row>\r\n      <ion-row *ngIf=\"!!packageStatus.downloadComplete || packageStatus.error\">\r\n        <ion-col>\r\n          <ion-button (click)=\"delete()\" expand=\"block\" color=\"danger\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.DELETE_BUTTON' | translate }}</ion-button>\r\n        </ion-col>\r\n      </ion-row>\r\n    </div>\r\n  </ion-grid>\r\n</ion-content>\r\n\r\n<ng-template #downloadPackage>\r\n  <ion-row>\r\n    <ion-col>\r\n      <ion-button [disabled]=\"isCheckingAvailableDiskspace\" (click)=\"startDownload()\" expand=\"block\"\r\n        color=\"varsom-orange\">{{ 'OFFLINE_MAP.MAP_PACKAGE_DETAILS_PAGE.DOWNLOAD_BUTTON' | translate }}</ion-button>\r\n    </ion-col>\r\n  </ion-row>\r\n</ng-template>","import { Component, OnInit, ChangeDetectionStrategy, Input, ChangeDetectorRef } from '@angular/core';\r\nimport { ModalController } from '@ionic/angular';\r\nimport * as L from 'leaflet';\r\nimport { CompoundPackageFeature, CompoundPackage } from '../metadata.model';\r\nimport { OfflineMapService } from 'src/app/core/services/offline-map/offline-map.service';\r\nimport { Observable } from 'rxjs';\r\nimport { OfflineMapPackage } from 'src/app/core/services/offline-map/offline-map.model';\r\nimport { takeUntil, tap } from 'rxjs/operators';\r\nimport { NgDestoryBase } from 'src/app/core/helpers/observable-helper';\r\n\r\n/**\r\n * Shows detail info about a specific offline map package. From here you may download or delete the package.\r\n */\r\n@Component({\r\n  templateUrl: './offline-package-modal.component.html',\r\n  styleUrls: ['./offline-package-modal.component.css'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OfflinePackageModalComponent extends NgDestoryBase implements OnInit {\r\n  @Input() feature: CompoundPackageFeature;\r\n  @Input() packageOnServer: CompoundPackage;\r\n  @Input() offlinePackageStatus$: Observable<OfflineMapPackage>;\r\n\r\n  zoom: number;\r\n  center: number[];\r\n  tileLayer: L.GeoJSON;\r\n  isCheckingAvailableDiskspace:boolean;\r\n\r\n  offlinePackageStatusThatTriggersChangeDetection$: Observable<OfflineMapPackage>;\r\n\r\n  constructor(\r\n    private modalController: ModalController,\r\n    private offlineMapService: OfflineMapService,\r\n    private cdr: ChangeDetectorRef,\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  ngOnInit(): void {\r\n    this.isCheckingAvailableDiskspace = false;\r\n    this.offlinePackageStatusThatTriggersChangeDetection$ = this.offlinePackageStatus$.pipe(\r\n      tap(() => this.cdr.detectChanges() ));\r\n    this.tileLayer = new L.GeoJSON(this.feature);\r\n\r\n    // Set center from package bounds\r\n    const { lat, lng } = this.tileLayer.getBounds().getCenter();\r\n    this.center = [lat, lng];\r\n\r\n    // Use offline map package root tile as zoom level\r\n    const [, , z] = this.packageOnServer.getXYZ();\r\n    this.zoom = z;\r\n\r\n    this.offlineMapService.finishedPackageIds$.pipe(\r\n      takeUntil(this.ngDestroy$)).subscribe((packageName) => {\r\n      if (this.packageOnServer.getName() === packageName) {\r\n        this.dismiss(); //close when package is unzipped and ready to use\r\n      }\r\n    });\r\n  }\r\n\r\n  showTileOnMap(map: L.Map) {\r\n    this.tileLayer.addTo(map);\r\n  }\r\n\r\n  async startDownload(): Promise<void> {\r\n    this.isCheckingAvailableDiskspace = true;\r\n    this.cdr.detectChanges();\r\n\r\n    if(await this.offlineMapService.checkAvailableDiskSpace(this.packageOnServer)) {\r\n      this.offlineMapService.downloadPackage(this.packageOnServer);\r\n    }\r\n    this.isCheckingAvailableDiskspace = false;\r\n    this.cdr.detectChanges();\r\n  }\r\n\r\n  getPercentage(map: OfflineMapPackage): number {\r\n    return Math.round((map.progress ? map.progress.percentage : 0) * 100);\r\n  }\r\n\r\n  cancel(map: OfflineMapPackage) {\r\n    this.offlineMapService.cancelDownloadPackage(map);\r\n  }\r\n\r\n  delete() {\r\n    this.offlineMapService.removeMapPackageByName(this.packageOnServer.getName());\r\n  }\r\n\r\n  dismiss() {\r\n    this.modalController.dismiss({\r\n      'dismissed': true\r\n    });\r\n  }\r\n}\r\n"]}