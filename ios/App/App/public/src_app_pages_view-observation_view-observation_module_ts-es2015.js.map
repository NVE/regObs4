{"version":3,"file":"src_app_pages_view-observation_view-observation_module_ts-es2015.js","mappings":"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","sources":["./src/app/modules/registration/edit-registration-helper-functions.ts","./src/app/pages/modal-pages/fullscreen-image-modal/fullscreen-image-modal.module.ts","./src/app/pages/view-observation/view-observation.module.ts","./src/app/pages/view-observation/view-observation.page.ts","./src/app/pages/view-observation/view-observation.page.html"],"sourcesContent":["import { RegistrationViewModel, MyPageData } from '@varsom-regobs-common/regobs-api';\r\nimport { Observable, of, timer } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport moment from 'moment';\r\n\r\nexport type EditMode = 'EDIT_AS_MODERATOR' | 'EDIT_OWN_REGISTRATION';\r\n\r\nexport function isSameObserver(reg: RegistrationViewModel, observer: MyPageData): boolean {\r\n  if (!observer) {\r\n    return false;\r\n  }\r\n  return observer.NickName === reg.Observer.NickName; // TODO: Change to ObserverID, when implemented in API model (MyPageData)\r\n}\r\n\r\nexport function isInGroup(reg: RegistrationViewModel, observer: MyPageData): boolean {\r\n  if (\r\n    observer &&\r\n    reg.ObserverGroupID > 0 &&\r\n    observer.MemberOfGroups &&\r\n    observer.MemberOfGroups.length > 0 &&\r\n    observer.MemberOfGroups.map((g) => g.Id).indexOf(reg.ObserverGroupID) >= 0\r\n  ) {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction isModerator(reg: RegistrationViewModel, observer: MyPageData): boolean {\r\n  if (observer && reg.GeoHazardTID) {\r\n    return observer.Roles?.includes(`ModeratorForGeoHazard${reg.GeoHazardTID}`);\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function getObserverEditCheckObservable(reg: RegistrationViewModel, observer: MyPageData): Observable<EditMode> {\r\n  if (isModerator(reg, observer)) {\r\n    return of('EDIT_AS_MODERATOR');\r\n  }\r\n  if (isSameObserver(reg, observer) || isInGroup(reg, observer)) {\r\n    return getWithin48HoursCheckUntilFalseObservable(reg).pipe(\r\n      map((within48hours) => (within48hours ? 'EDIT_OWN_REGISTRATION' : undefined))\r\n    );\r\n  }\r\n  return of(undefined);\r\n}\r\n\r\nexport function getWithin48HoursCheckUntilFalseObservable(reg: RegistrationViewModel): Observable<boolean> {\r\n  const completeWith =\r\n    <T>(predicate: (arg: T) => boolean) =>\r\n    (source: Observable<T>) =>\r\n      new Observable<T>((observer) =>\r\n        source.subscribe(\r\n          (value) => {\r\n            observer.next(value);\r\n            if (predicate(value)) {\r\n              observer.complete();\r\n            }\r\n          },\r\n          (error) => observer.error(error),\r\n          () => observer.complete()\r\n        )\r\n      );\r\n\r\n  const forthyEightHoursInMS = 48 * 60 * 60 * 1000;\r\n  const timerCheckEveryMinuteMS = 60 * 1000;\r\n  return timer(0, timerCheckEveryMinuteMS).pipe(\r\n    map(() => isWithinMilliseconds(moment(reg.DtRegTime), forthyEightHoursInMS)),\r\n    completeWith((val) => !val)\r\n  );\r\n}\r\n\r\nexport function isWithinMilliseconds(m: moment.Moment, msLimit: number, now: moment.Moment = moment()): boolean {\r\n  if (!m) {\r\n    return false;\r\n  }\r\n  return m.isSameOrAfter(now.subtract(msLimit, 'milliseconds'));\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { IonicModule } from '@ionic/angular';\r\nimport { FullscreenImageModalPage } from './fullscreen-image-modal.page';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, IonicModule, FormsModule],\r\n  declarations: [FullscreenImageModalPage],\r\n  entryComponents: [FullscreenImageModalPage]\r\n})\r\nexport class FullscreenImageModalPageModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { Routes, RouterModule } from '@angular/router';\r\nimport { ViewObservationPage } from './view-observation.page';\r\nimport { SharedModule } from '../../modules/shared/shared.module';\r\nimport { FullscreenImageModalPageModule } from '../modal-pages/fullscreen-image-modal/fullscreen-image-modal.module';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: ViewObservationPage\r\n  }\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    SharedModule,\r\n    FullscreenImageModalPageModule,\r\n    RouterModule.forChild(routes)\r\n  ],\r\n  declarations: [ViewObservationPage]\r\n})\r\nexport class ViewObservationPageModule {}\r\n","import { Component, OnInit, ChangeDetectionStrategy } from '@angular/core';\r\nimport { ActivatedRoute, Router } from '@angular/router';\r\nimport { ObservationService } from '../../core/services/observation/observation.service';\r\nimport { UserSettingService } from '../../core/services/user-setting/user-setting.service';\r\nimport { RegistrationViewModel } from '@varsom-regobs-common/regobs-api';\r\nimport { PopupInfoService } from '../../core/services/popup-info/popup-info.service';\r\nimport { NgDestoryBase } from '../../core/helpers/observable-helper';\r\nimport { takeUntil, switchMap, withLatestFrom, tap } from 'rxjs/operators';\r\nimport { RegistrationService } from 'src/app/modules/common-registration/registration.services';\r\nimport { from, Observable } from 'rxjs';\r\nimport { EditMode, getObserverEditCheckObservable } from 'src/app/modules/registration/edit-registration-helper-functions';\r\nimport { RegobsAuthService } from 'src/app/modules/auth/services/regobs-auth.service';\r\n\r\n@Component({\r\n  selector: 'app-view-observation',\r\n  templateUrl: './view-observation.page.html',\r\n  styleUrls: ['./view-observation.page.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ViewObservationPage extends NgDestoryBase implements OnInit {\r\n  editMode$: Observable<EditMode>;\r\n  registrationViewModel$: Observable<RegistrationViewModel>;\r\n\r\n  constructor(\r\n    private activatedRoute: ActivatedRoute,\r\n    private observationService: ObservationService,\r\n    private userSettingService: UserSettingService,\r\n    private popupInfoService: PopupInfoService,\r\n    private registrationService: RegistrationService,\r\n    private router: Router,\r\n    private regobsAuthService: RegobsAuthService\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  async editRegistration(registration: RegistrationViewModel) {\r\n    const reg = await this.registrationService.editExistingRegistrationAndSave(registration);\r\n    this.router.navigate(['registration', 'edit', reg.id]);\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.popupInfoService.checkObservationInfoPopup().pipe(takeUntil(this.ngDestroy$)).subscribe();\r\n    const id = parseInt(this.activatedRoute.snapshot.params['id'], 10);\r\n    this.registrationViewModel$ = this.userSettingService.userSetting$.pipe(\r\n      switchMap((userSetting) => from(this.observationService.getObservationById(id, userSetting.appMode, userSetting.language)))\r\n    );\r\n    this.editMode$ = this.createEditMode$();\r\n  }\r\n\r\n  private createEditMode$(): Observable<EditMode> {\r\n    return this.registrationViewModel$.pipe(\r\n      withLatestFrom(this.regobsAuthService.myPageData$),\r\n      switchMap(([reg, observer]) => getObserverEditCheckObservable(reg, observer))\r\n    );\r\n  }\r\n}\r\n","<ion-header>\r\n  <ion-toolbar appHeaderColor mode=\"ios\">\r\n    <ion-buttons slot=\"start\">\r\n      <ion-back-button text=\"\" defaultHref=\"/\"></ion-back-button>\r\n    </ion-buttons>\r\n    <ion-title>\r\n      {{'REGISTRATION.OVERVIEW.TITLE' | translate}}\r\n    </ion-title>\r\n  </ion-toolbar>\r\n</ion-header>\r\n<ion-content *ngIf=\"registrationViewModel$ | async as registration\">\r\n  <ng-container *ngIf=\"editMode$ | async as editMode\">\r\n    <span *ngIf=\"editMode === 'EDIT_AS_MODERATOR'\">\r\n      {{ \"RegistrationDetail.EditInfoAsModerator\" | translate }}\r\n    </span>\r\n    <span *ngIf=\"editMode === 'EDIT_OWN_REGISTRATION'\">\r\n      {{ \"RegistrationDetail.EditInfo\" | translate }}\r\n    </span>\r\n    <ion-button (click)=editRegistration(registration)>Edit registration</ion-button>\r\n  </ng-container>\r\n  <app-observation-list-card [obs]=\"registration\"></app-observation-list-card>\r\n</ion-content>"],"names":[],"sourceRoot":"webpack:///"}